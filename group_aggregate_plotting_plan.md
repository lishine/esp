# Architectural Plan: Group Aggregate Data Plotting (Separate Charts with Dedicated Options)

This plan outlines the architectural changes for visualizing `GroupAggregate` data. It involves introducing a new, separate chart component for group averages, displayed above the existing chart when a master toggle is active. The existing chart will then display averaged data for its series. Both charts will have synchronized x-axes and crosshairs. Each chart will have its ECharts options generated by a dedicated composable.

**I. New Vue Component: `GroupAveragesChart.vue`**

1.  **Creation:**
    - File: `chart/src/components/GroupAveragesChart.vue`.
2.  **Structure:**
    - Uses `VChart` from `vue-echarts`.
    - Props: `options: ECOption | null`, `height: string`, `width: string`, `theme: string`.
    - Internal `chartRef` for the ECharts instance.
3.  **Legend Handling:**
    - Implements `handleLegendSelectChanged` method.
    - This method calls an action in `sessionDataStore` (e.g., `setGroupAverageSeriesVisibility`) to update and persist (to localStorage) the visibility state of its series.
4.  **Expose ECharts Instance:**
    - Provides a mechanism (e.g., template ref and public method) for `DataDisplayView.vue` to access its ECharts instance for `echarts.connect()`.

**II. `DataDisplayView.vue` Modifications**

1.  **Conditional Rendering:**
    - Import `GroupAveragesChart.vue`.
    - Use `v-if="sessionDataStore.showGroupAveragesMaster"` to conditionally render `<group-averages-chart ... />` above `<sensor-chart ... />`.
2.  **Chart Options:**
    - Call `useChartOptions(...)` to get `chartOptionsMain`.
    - Call the new `useGroupAveragesChartOptions(...)` to get `chartOptionsGroupAverages`.
3.  **Props for Charts:**
    - Pass `chartOptionsGroupAverages` to `<group-averages-chart />`.
    - Pass `chartOptionsMain` to `<sensor-chart />`.
4.  **ECharts Synchronization:**
    - Obtain ECharts instances from both chart components.
    - In `onMounted` (or when both instances are ready), call `echarts.connect([instanceGroupAverages, instanceMainChart])`.

**III. Chart Options Composables**

1.  **Existing `useChartOptions.ts` (for Main/Lower Chart - `chart/src/components/ChartOptions.ts`):**

    - **Responsibility:** Generates `chartOptionsMain` for the existing `SensorChart.vue`.
    - **Series Data Source:** Consumes `chartFormattedData.value.series` from `sessionDataStore`. This data will be:
      - 3-second moving averages if `sessionDataStore.showGroupAveragesMaster` is `true` (due to logic in `chartFormatters.ts`).
      - Raw/interpolated data if `sessionDataStore.showGroupAveragesMaster` is `false`.
    - **Legend Names:** Remain unchanged as per `CANONICAL_SERIES_CONFIG`.
    - **Return Value:** `chartOptionsMain: ComputedRef<ECOption | null>`.

2.  **New `useGroupAveragesChartOptions.ts` (for New/Upper Chart):**
    - **Creation:** Create file e.g., `chart/src/components/chart/useGroupAveragesChartOptions.ts`.
    - **Responsibility:** Generates `chartOptionsGroupAverages` for `GroupAveragesChart.vue`.
    - **Inputs:** Reactive refs for `groupAggregates`, `GROUP_AVERAGE_SERIES_CONFIG`, `groupAverageSeriesVisibility`.
    - **Logic for `chartOptionsGroupAverages`:**
      - **Grid:** Single grid.
      - **X-Axis:** `type: 'time'`.
      - **Y-Axes:** Dynamically generated based on visible series from `GROUP_AVERAGE_SERIES_CONFIG`.
      - **Series:** Generated from `groupAggregates` data. Data points form horizontal lines per group.
      - **Legend:** Configured with data from `GROUP_AVERAGE_SERIES_CONFIG` and `groupAverageSeriesVisibility`. Positioned at the top of this chart.
      - **Tooltip & DataZoom:** Standard configuration.
    - **Return Value:** `chartOptionsGroupAverages: ComputedRef<ECOption | null>`.

**IV. State Management (`sessionDataStore.ts`) & Data Formatting (`chartFormatters.ts`)**

1.  **`chart/src/stores/seriesConfig.ts`:**
    - Define `GROUP_AVERAGE_SERIES_CONFIG` (array of config objects for each group average metric: `displayName`, `internalId`, `dataKey`, `unit`, `decimals`, `color`, `yAxisIndex`).
2.  **`chart/src/stores/sessionDataStore.ts`:**
    - State: `groupAggregates: Ref<GroupAggregate[]>`, `showGroupAveragesMaster: Ref<boolean>` (persisted), `groupAverageSeriesVisibility: Ref<Record<string, boolean>>` (persisted for the new chart's legend).
    - Actions for updating these states.
    - Ensure `showGroupAveragesMaster` state is passed to/accessible by `chartFormatters.getChartFormattedData`.
3.  **`chart/src/stores/chartFormatters.ts` (`getChartFormattedData` function):**
    - If `showGroupAveragesMaster` is true, generate 3-second moving averages for the main series data.
    - Otherwise, provide raw/interpolated data.
    - Legend names for main series are not altered by this averaging.
4.  **New Moving Average Utility (e.g., `chart/src/utils/calcSeries.ts`):**
    - `calculateMovingAverageForSeries(points: Array<[Date, number | null]>, windowMs: number): Array<[Date, number | null]>`.

**V. UI Controls (in `DataDisplayView.vue` or dedicated component)**

1.  Master toggle switch bound to `sessionDataStore.showGroupAveragesMaster`.
2.  When master toggle is ON:
    - Display individual toggle switches for each series in `GROUP_AVERAGE_SERIES_CONFIG`, controlling `sessionDataStore.groupAverageSeriesVisibility`. These toggles are associated with the new upper chart's legend.

**Mermaid Diagram (High-Level Interaction):**

```mermaid
graph TD
    U[UI Controls] -- toggles --> SD[sessionDataStore (showGroupAveragesMaster, groupAverageSeriesVisibility)];
    SD -- provides showGroupAveragesMaster --> CF[chartFormatters.ts];
    LogEntries --> CF;
    CF -- produces FormattedMainChartData (raw OR averaged) --> SD;

    SD -- provides FormattedMainChartData --> UCOMain[useChartOptions.ts];
    SD -- provides groupAggregates, group vis states --> UCOGroup[useGroupAveragesChartOptions.ts];
    SeriesConfigs --> UCOMain;
    GroupSeriesConfigs --> UCOGroup;

    UCOMain -- generates --> OptLower[chartOptionsMain];
    UCOGroup -- generates --> OptUpper[chartOptionsGroupAverages];

    DDV[DataDisplayView.vue];
    DDV -- uses --> UCOMain;
    DDV -- uses --> UCOGroup;
    DDV -- renders & passes OptUpper --> GAC[GroupAveragesChart.vue (New)];
    DDV -- renders & passes OptLower --> SC[SensorChart.vue (Existing)];
    DDV -- calls --> ECHCON((echarts.connect));
    GAC -- ECharts instance --> ECHCON;
    SC -- ECharts instance --> ECHCON;

    GAC -- legend events update --> SD;
```

This refined plan introduces better modularity for chart option generation.
